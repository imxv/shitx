# ShitX 游戏循环逻辑文档

## 游戏概述

ShitX 是一款基于狼人杀机制的社交推理游戏。游戏的核心是找出"拉屎的人"（相当于狼人）。

## 角色设定

### 邪恶阵营
- **💩 拉屎的人**（1人）
  - 相当于狼人杀中的狼人
  - 夜晚可以"恶心"一个孕妇，使其取消参赛资格
  - 目标：消灭所有好人

- **🍯 尿瓶子的人**（1人，6人局以上）
  - 相当于狼人杀中的狼兄弟
  - 知道谁是拉屎的人，但拉屎的人不知道他
  - 无特殊能力，仅通过白天的发言和投票帮助拉屎的人
  - 目标：帮助拉屎的人获胜

### 好人阵营
- **🐕‍🦺 警犬**（1人，4人局以上）
  - 相当于狼人杀中的预言家
  - 夜晚可以检查一个玩家是否是拉屎的人
  - 检查结果会公开显示在游戏历史中

- **🧹 保洁员**（1人，5人局以上）
  - 相当于狼人杀中的守卫
  - 夜晚可以保护一个孕妇免受恶心
  - 可以连续保护同一个人

- **🤰 孕妇**（剩余人数）
  - 相当于狼人杀中的平民
  - 无特殊能力
  - 目标：通过投票找出拉屎的人

## 游戏流程

### 1. 游戏初始化
```typescript
initGame(playerCount) {
  1. 根据玩家数量分配角色
  2. 随机打乱角色分配
  3. 随机选择一个玩家作为当前控制的玩家（currentPlayerId）
  4. 设置游戏状态为白天
  5. 初始化第1轮
}
```

### 2. 白天阶段
- **可执行行动**：投票
- **行动流程**：
  1. 所有存活玩家可以投票选择一个玩家取消参赛资格
  2. 被投票的玩家立即取消参赛资格
  3. 进入夜晚阶段

### 3. 夜晚阶段
- **可执行行动**：
  - 拉屎的人：恶心一个孕妇
  - 警犬：检查一个玩家身份
  - 保洁员：保护一个孕妇
  
- **行动流程**：
  1. 当前玩家根据角色执行相应行动
  2. 行动完成后，点击"进入白天"按钮
  3. 系统处理夜晚行动结果：
     - 如果被恶心的孕妇没有被保护，则取消参赛资格
     - 如果被保护，则显示"被保护了"
  4. 进入下一轮的白天阶段

### 4. 游戏结束判定
在每个阶段转换时检查：
- **好人获胜**：拉屎的人被投票取消参赛资格
- **邪恶阵营获胜**：所有好人（孕妇、警犬、保洁员）都被取消参赛资格

## 关键状态管理

### GameState 结构
```typescript
{
  players: Player[],           // 所有玩家
  phase: GamePhase,           // 当前阶段（day/night/gameOver）
  currentRound: number,       // 当前轮数
  currentPlayerId: string,    // 当前控制的玩家ID
  nightActions: {             // 夜晚行动记录
    dogCheck: string | null,
    cleanerProtect: string | null,
    pooperTarget: string | null
  },
  gameResult: 'pooperWin' | 'goodWin' | null,
  actionHistory: string[]     // 游戏历史记录
}
```

### Player 结构
```typescript
{
  id: string,
  name: string,
  role: PlayerRole,
  isAlive: boolean,
  isProtected: boolean,    // 当前是否被保护
  wasChecked: boolean      // 是否被警犬检查过
}
```

## 特殊机制

### 1. 单人游戏体验
- 游戏开始时随机分配一个角色给玩家控制
- 玩家只能看到自己的角色身份
- 玩家只能在自己存活时执行行动
- 玩家被取消参赛资格后只能观看游戏进程

### 2. 信息可见性
- 所有玩家的行动历史都是公开的
- 警犬的检查结果会公开显示
- 尿瓶子的人可以看到谁是拉屎的人（单向可见）
- 游戏结束后揭晓所有角色

### 3. 行动限制
- 每个夜晚每个角色只能行动一次
- 不能对自己使用能力
- 只能对存活的玩家使用能力

## 游戏平衡性

### 人数配置
- 4人局：1拉屎 + 1警犬 + 2孕妇
- 5人局：1拉屎 + 1警犬 + 1保洁员 + 2孕妇
- 6人局：1拉屎 + 1尿瓶子 + 1警犬 + 1保洁员 + 2孕妇
- 7-10人局：在6人基础上增加孕妇

### 胜率平衡
- 好人优势：警犬可以验人，保洁员可以保护
- 邪恶优势：6人以上有尿瓶子的人协助，单向信息优势
- 白天投票是好人的主要武器，夜晚行动是邪恶阵营的主要武器

## 已知问题和解决方案

### Bug 1: 用户角色分配问题
**问题**：之前使用查找非孕妇角色的逻辑，导致用户可能无法扮演某些角色
**解决**：使用 currentPlayerId 追踪当前玩家，确保任何角色都可能被分配给用户

### Bug 2: 游戏重启问题
**问题**：当用户扮演拉屎的人且邪恶阵营获胜时，可能无法重新开始游戏
**解决**：在重新开始游戏时清除选中的行动状态

## 未来改进方向

1. **多人联机**：实现真正的多人在线游戏
2. **AI对手**：为其他玩家添加AI逻辑
3. **更多角色**：如女巫、猎人等经典狼人杀角色的变体
4. **技能冷却**：限制连续保护同一人
5. **私密信息**：警犬验人结果可选择是否公开